<!DOCTYPE html>
<html lang="zh-cmn-Has-ZN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="description" content="Dropper">
    <title>Dropper</title>
    <link rel="icon" type="image/x-icon" href="//qiniu.yuhuofei.it/favicon.ico">
    <link rel="stylesheet" href="https://cdn.staticfile.org/bulma/0.9.4/css/bulma.min.css">
    <script src="//cdn.staticfile.org/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="//cdn.staticfile.org/qiniu-js/3.4.1/qiniu.min.js"></script>
    <style>
    html, body {
        margin: 0;
        width: 100vw;
        height: 100%;
        overflow: hidden;
        position: relative;
        font-family: "Helvetica Neue", sans-serif;
        user-select: none;
        background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        background-size: 400% 400%;
        animation: gradient 12s ease infinite;
    }

    @keyframes gradient {
        0% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }

        100% {
            background-position: 0% 50%;
        }
    }
    .logo {
        padding: 20px;
        color: #fff;
        font-weight: 200;
        letter-spacing: 3px;
    }

    #settingBtn {
        position: absolute;
        right: 0;
        top: 0;
        padding: 20px;
        font-size: 1.2em;
        transition: transform .5s;
        box-sizing: content-box;
    }

    .setting-wrap:hover #settingBtn {
        transform: rotate(60deg);
    }
    .setting-wrap:hover #setting {
        right: 0;
        opacity: 1;
    }
    #setting {
        padding: 20px;
        position: absolute;
        z-index: 1000;
        top: 0;
        width: 300px;
        right: -300px;
        height: 100%;
        background: #fff;
        box-shadow: 0 0 40px 0 #999;
        opacity: 0;
        transition: .5s;
    }

    .upload-wrap {
        width: 300px;
        margin: 0 auto;
    }
    .upload-box {
        margin: 12vh 0 60px; 
        padding: 10% 10% 20%;
        border-radius: 0.8rem;
        border: 2px dashed rgba(255,255,255, .5);
        background: rgba(255,255,255, .5);
        position: relative;
        text-align: center;
        transition: 0.3s;
        width: 100%;
    }
    .upload-box:hover {
        background: rgba(255,255,255, .68);
    }
    .upload-box input {
        cursor: pointer;
    }

    #result {
        height: 0;
        transition: .5s;
        overflow: hidden;
    }
    </style>
</head>

<body tabIndex=0>
    <div class="logo">Dropper</div>
    <div class="upload-wrap">
        <div class="upload-box">
            <input id="fileInput" class="file-input" type="file" onclick="value=null">
            <p style="font-size: 5em">ğŸ—‚ï¸</p>
            <span id='desc'>ç‚¹å‡»é€‰æ‹© æˆ– æ‹–å…¥æ–‡ä»¶</span>
        </div>
        <div id="shareBox" class="field has-addons">
            <div class="control is-expanded">
                <div class="select is-fullwidth">
                    <select id='expire'>
                        <option value="86400">æœ‰æ•ˆæœŸä¸€å¤©</option>
                        <option value="604800">æœ‰æ•ˆæœŸä¸€å‘¨</option>
                        <option value="2592000">æœ‰æ•ˆæœŸä¸€æœˆ</option>
                        <option value="3153600000">æœ‰æ•ˆæœŸæ°¸ä¹…</option>
                    </select>
                </div>
            </div>
            <div class="control">
                <button id="share" class="button is-link is-light">åˆ†äº«</button>
            </div>
        </div>
        <div id="downloadBox" class="field has-addons" style="display: none">
            <div class="control is-expanded">
                <input id='secret' class="input" placeholder="è¾“å…¥æå–ç ">
            </div>
            <div class="control">
                <button id="download" class="button is-link is-light">ä¸‹è½½</button>
            </div>
        </div>
        <div id="result" class="control is-loading">
            <textarea id='shareMsg' class="textarea is-link" placeholder="åˆ†äº«ç”Ÿæˆä¸­..."></textarea>
            <i class="help">å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªåˆ‡æ¿</i>
        </div>
    </div>
    <div class="setting-wrap">
        <span id="settingBtn">âš™ï¸</span>
        <div id="setting">
            <h4>åŸºç¡€å‚æ•°</h4>
            <i class="help">ä»¥ä¸‹å‚æ•°ä»…ä¿å­˜åœ¨æœ¬åœ°</i><br>
            <input id="ak" class="input is-small" name="AK" placeholder="AccessKey">
            <input id="sk" class="input is-small" name="SK" placeholder="SecretKey">
            <i class="help">è®¿é—® <a href="https://portal.qiniu.com/user/key" target="_blank">å¯†é’¥ç®¡ç†</a> è·å–</i>
            <br>
            <input id="bucket" class="input is-small" name="BUCKET" placeholder="bucket">
            <i class="help">è®¿é—® <a href="https://portal.qiniu.com/kodo/bucket" target="_blank">ç©ºé—´ç®¡ç†</a> åˆ›å»ºæˆ–é€‰æ‹©</i>
            <br>
            <i class="help">è¯·åœ¨ç©ºé—´è®¾ç½®å¤„å°†é»˜è®¤é¦–é¡µå¼€å¯ï¼Œå¹¶å°† <a href="" download="index.html">index.html</a> æ–‡ä»¶ä¸Šä¼ è‡³ç©ºé—´</i>
            <i class="help">æœ‰æ•ˆæœŸåŠæå–ç åªèƒ½ç›¸å¯¹å®‰å…¨çš„ä¿æŠ¤æ–‡ä»¶ï¼Œé‡è¦æ–‡ä»¶åˆ†äº«åè¯·åˆ°ä¸ƒç‰›åˆ é™¤</i>
            <i class="help">ä½¿ç”¨æµ‹è¯•åŸŸåè¯·æ³¨æ„<a href="https://developer.qiniu.com/fusion/kb/1319/test-domain-access-restriction-rules" target="_blank">ä½¿ç”¨è§„èŒƒ</a></i>
            <i class="help"><a href="https://github.com/sciooga/Dropper" target="_blank">â¤ï¸ GitHub/Dropper</a></i>
        </div>
    </div>
    <script>
    var AK = ak.value = localStorage.getItem('AK')
    var SK = sk.value = localStorage.getItem('SK')
    var BUCKET = bucket.value = localStorage.getItem('BUCKET')
    var DOMAIN = location.origin

    var utf16to8 = function(str) {
        var out, i, len, c
        out = ""
        len = str.length
        for (i = 0; i < len; i++) {
            c = str.charCodeAt(i)
            if ((c >= 0x0001) && (c <= 0x007F)) {
                out += str.charAt(i)
            } else if (c > 0x07FF) {
                out += String.fromCharCode(0xE0 | ((c >> 12) & 0x0F))
                out += String.fromCharCode(0x80 | ((c >> 6) & 0x3F))
                out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F))
            } else {
                out += String.fromCharCode(0xC0 | ((c >> 6) & 0x1F))
                out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F))
            }
        }
        return out
    }

    // ç”Ÿæˆä¸ƒç‰› upload token
    var genUpToken = function(bucketName, deadline) {
        var putPolicy = { "scope": bucketName, "deadline": deadline }
        var encoded = btoa(utf16to8(JSON.stringify(putPolicy)))
        var signature = CryptoJS.HmacSHA1(encoded, SK)
        var encoded_signed = signature.toString(CryptoJS.enc.Base64)
        encoded_signed = encoded_signed.replace(/\+/g, "-") // url å®‰å…¨çš„ base64
        encoded_signed = encoded_signed.replace(/\//g, "_")
        var upload_token = AK + ":" + encoded_signed + ":" + encoded
        return upload_token
    }

    var FILE_NAME, SECRET // ç”Ÿæˆåˆ†äº«é“¾æ¥æ—¶ä¼šç”¨åˆ°ï¼Œé€šè¿‡å…¨å±€å˜é‡ä¼ é€’
    var dropHandler = function(e) {
        if (!AK || !SK || !BUCKET) return alert('è¯·å…ˆåœ¨å³ä¸Šè§’é…ç½®åŸºç¡€å‚æ•°')

        var fileList = e.dataTransfer ? e.dataTransfer.files : e.target.files
        if (!fileList.length) return
        if (fileList.length != 1) return alert('åªæ”¯æŒä¸Šä¼ å•ä¸ªæ–‡ä»¶')

        FILE_NAME = fileList[0].name
        SECRET = Math.random().toString(36).slice(-8) // ç”Ÿæˆéšæœºå¯†ç 
        var upToken = genUpToken(BUCKET, 16666666666) // å†™æ­»ä¸€ä¸ªè¶…å¤§çš„æ—¥æœŸ

        var observable = qiniu.upload(fileList[0], `${FILE_NAME}@${SECRET}`, upToken)
        var subscription = observable.subscribe({
            next: function(e) {
                desc.innerText = e.total.percent.toFixed(2) + '%'
            },
            error: function(e) {
                alert(e.message)
                location.reload()
            },
            complete: function(e) {
                desc.innerText = FILE_NAME
            }
        })
    }

    var hash160724 = function(str, salt) {
        for (var i = 0; i < 160724; i++) {
            str = CryptoJS.MD5(str + salt).toString()
        }
        return str
    }


    setting.addEventListener('change', function(e) {
        localStorage.setItem(e.target.name, e.target.value)
        window[e.target.name] = e.target.value;
    })

    window.onload = function() {
        var searchParams = new URL(location.href).searchParams
        var secretMD5 = searchParams.get('s')
        var dt = searchParams.get('dt')
        var fileName = searchParams.get('n')
        if (fileName) {
            // ä¸‹è½½æ¨¡å¼
            desc.innerText = fileName
            shareBox.style.display = 'none'
            fileInput.style.display = 'none'
            downloadBox.style.display = 'flex'

            download.addEventListener('click', function() {
                if (dt < new Date) return alert('æ–‡ä»¶åˆ†äº«åˆ°æœŸï¼Œæ— æ³•ä¸‹è½½')
                if (hash160724(secret.value, `${fileName}@${dt}`) != secretMD5) return alert('æå–ç é”™è¯¯')

                downloadURL = `${DOMAIN}/${fileName}@${secret.value}?attname=${fileName}`
                window.open(downloadURL)
            })
        } else {
            // ä¸Šä¼ æ¨¡å¼
            document.addEventListener("dragover", function(e) {
                e.preventDefault()
            })

            document.addEventListener("drop", function(e) {
                e.preventDefault()
                dropHandler(e)
            })
            fileInput.addEventListener('change', dropHandler)

            share.addEventListener('click', function() {
                if (!FILE_NAME) return alert('è¯·ä¸Šä¼ æ–‡ä»¶')
                result.style.height = '200px'
                setTimeout(function() {
                    var dt = +new Date + expire.value * 1000
                    var secretMD5 = hash160724(SECRET, `${FILE_NAME}@${dt}`)
                    var resultURL = `${DOMAIN}?s=${secretMD5}&n=${encodeURI(FILE_NAME)}&dt=${dt}`

                    shareMsg.value = `é“¾æ¥: ${resultURL} æå–ç : ${SECRET}`
                    result.classList.remove('is-loading')
                    shareMsg.select();
                    document.execCommand('copy', true);
                }, 500)
            })
        }
    }
    </script>
</body>

</html>
